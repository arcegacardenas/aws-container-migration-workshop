node {

   stage 'Checkout'
   git 'https://github.com/omarlari/aws-container-migration-workshop.git'

   agent {
      docker {
         image: 'maven:3.5-jdk-7'
         args '-v /home/ec2-user/jenkins-data/workspace/aws-workshop:/workshop'
      }
   }
   stages: {
      stage('Build'){
         dockerfile{
            filename 'Dockerfile.build'
            dir '/workshop/Lab7'
         }
      }
   }





   /*stage 'Build Dockerfile'
   docker.build('hello')

   stage 'Push to ECR'
   sh ("eval \$(docker run awscli aws ecr get-login --region ${REGION} --no-include-email | sed 's|https://||')")
   docker.withRegistry('https://${ECR_REPO}') {
       docker.image('hello').push('${BUILD_NUMBER}')
   }

   stage 'update application'

   parallel(
        kubernetes: { node {
        docker.image('kubectl').inside("--volume=/home/ec2-user/.kube:/config/.kube"){
            sh 'kubectl describe deployment ${APP}'
            sh 'kubectl set image deployment/${APP} movies=${ECR_REPO}/hello:${BUILD_NUMBER}'
            sh 'kubectl describe deployment ${APP}'
            }
        }}
   )*/
}

pipeline {
    agent none
    stages {

        stage 'Checkout'
        git 'https://github.com/omarlari/aws-container-migration-workshop.git'

        stage('Example Build') {
            agent {
               docker {
                  image: 'maven:3.5-jdk-7'
                  args '-v /home/ec2-user/jenkins-data/workspace/aws-workshop:/workshop'
               }
            }
            steps {
                echo 'Hello, Maven'
                sh 'mvn --version'
                sh 'mkdir -p /usr/src/app'
                sh 'cp /workshop/app/pom.xml /usr/src/app/'
                sh 'cd /usr/src/app'
                sh 'mvn dependency:go-offline'
                sh 'cp -R /workshop/app /usr/src/app'
                sh 'mvn package -Dmaven.test.skip=true'
                sh 'cp /usr/src/app/target/applicationPetstore.war'
            }
        }

    }
}
